@extends('layouts.app')
@section('content')
<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-xl font-semibold">PPPoE — {{ $mikrotik->name }} ({{ $mikrotik->host }}:{{ $mikrotik->port }})</h2>
    <div class="flex gap-2">
      <form method="GET" action="{{ route('mikrotik.pppoe',['mikrotik'=>$mikrotik->id]) }}" class="flex gap-2">
        <input name="q" value="{{ $q ?? '' }}" class="inp w-64" placeholder="Cari user/IP/komentar…">
        <button class="btn" type="submit">Search</button>
        @if(!empty($q))
          <a class="btn-outline" href="{{ route('mikrotik.pppoe',['mikrotik'=>$mikrotik->id]) }}">Reset</a>
        @endif
      </form>
      <a href="{{ route('mikrotik.dashboard',['mikrotik'=>$mikrotik->id]) }}" class="btn-outline">Kembali Dashboard</a>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-6">
    <div class="card">
      <div class="font-semibold mb-2">Tambah Client</div>
      <form method="POST" action="{{ route('mikrotik.pppoe.add',['mikrotik'=>$mikrotik->id]) }}">
        @csrf
        <label class="lbl">Username</label>
        <input name="name" class="inp w-64" required>
        <label class="lbl mt-3">Password</label>
        <input name="password" class="inp w-64" required>
        <label class="lbl mt-3">Profil</label>
        <select name="profile" class="inp w-64 short-select">
          <option value="">default</option>
          @foreach(($profiles ?? []) as $p)
            @php $pn=$p['name']??''; $rl=$p['rate-limit']??''; @endphp
            @if($pn!=='') <option value="{{ $pn }}">{{ $pn }}@if($rl) ({{ $rl }}) @endif</option> @endif
          @endforeach
        </select>
        <label class="lbl mt-3"><input type="checkbox" name="record" value="1"> Rekam trafik client ini</label>
        <div class="mt-3"><button class="btn">SIMPAN</button></div>
      </form>
    </div>

    <div class="card">
      <div class="font-semibold mb-2">Tambah Profil PPPoE</div>
      <form method="POST" action="{{ route('mikrotik.pppoe.profile.add',['mikrotik'=>$mikrotik->id]) }}">
        @csrf
        <label class="lbl">Nama Profil</label>
        <input name="pname" class="inp w-64" required placeholder="mis: 10M">
        <label class="lbl mt-3">Rate-limit</label>
        <input name="rate" class="inp w-64" required placeholder="contoh: 10M/2M">
        <label class="lbl mt-3">Parent Queue (opsional)</label>
        <input name="parent" class="inp w-64" placeholder="mis: GLOBAL-PPP">
        <div class="muted mt-2">Parent akan di-set via on-up script saat user connect.</div>
        <div class="mt-3"><button class="btn">SIMPAN PROFIL</button></div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="font-semibold mb-2">Active Sessions</div>
    <div class="muted mb-2">Total: {{ count($active) }}</div>
    <div class="tbl">
      <div class="tr th"><div>Nama</div><div>Address</div><div>Uptime</div></div>
      @forelse($active as $a)
        <div class="tr"><div>{{ $a['name'] ?? '' }}</div><div>{{ $a['address'] ?? '' }}</div><div>{{ $a['uptime'] ?? '' }}</div></div>
      @empty <div class="muted">Tidak ada sesi aktif.</div>
      @endforelse
    </div>
  </div>

  <div class="card">
    <div class="font-semibold mb-2">Secrets</div>
    <div class="tbl">
      <div class="tr th"><div>Nama</div><div>Profil</div><div>Rekam</div><div>Status</div><div class="right">Aksi</div></div>
      @forelse($secrets as $s)
        @php $nm=$s['name']??''; $isDis=(($s['disabled']??'false')==='true'); $cur=$s['profile']??''; $isRec=(bool)($recMap[$nm]??false); @endphp
        <div class="tr">
          <div>{{ $nm }}</div>
          <div>
            <form method="POST" action="{{ route('mikrotik.pppoe.edit',['mikrotik'=>$mikrotik->id]) }}" class="inline">
              @csrf
              <input type="hidden" name="name" value="{{ $nm }}">
              <select name="profile" class="inp w-40 short-select">
                <option value="" {{ $cur==''?'selected':'' }}>default</option>
                @foreach(($profiles ?? []) as $p)
                  @php $pn=$p['name']??''; @endphp
                  @if($pn!=='') <option value="{{ $pn }}" {{ $cur===$pn?'selected':'' }}>{{ $pn }}</option> @endif
                @endforeach
              </select>
              <button class="btn-outline">Update</button>
            </form>
          </div>
          <div>
            <form method="POST" action="{{ route('mikrotik.pppoe.record',['mikrotik'=>$mikrotik->id]) }}">
              @csrf
              <input type="hidden" name="name" value="{{ $nm }}">
              <label class="lbl"><input type="checkbox" name="enable" value="1" onchange="this.form.submit()" {{ $isRec?'checked':'' }}> Rekam</label>
            </form>
          </div>
          <div>{{ $isDis?'Disabled':'Enabled' }}</div>
          <div class="right">
            <form method="POST" action="{{ route('mikrotik.pppoe.edit',['mikrotik'=>$mikrotik->id]) }}" class="inline">
              @csrf
              <input type="hidden" name="name" value="{{ $nm }}">
              <input type="hidden" name="action" value="{{ $isDis?'enable':'disable' }}">
              <button class="btn-outline">{{ $isDis?'Enable':'Disable' }}</button>
            </form>
            <form method="POST" action="{{ route('mikrotik.pppoe.delete',['mikrotik'=>$mikrotik->id]) }}" class="inline" onsubmit="return confirm('Hapus client {{ $nm }}?')">
              @csrf
              <input type="hidden" name="name" value="{{ $nm }}">
              <button class="btn" style="background:#ef4444;color:#fff">Hapus</button>
            </form>
          </div>
        </div>
      @empty <div class="muted">Data tidak ditemukan.</div>
      @endforelse
    </div>
  </div>
</div>

<style>
  .card{background:#0f1428;border:1px solid #1e2a4a;border-radius:14px;padding:16px}
  .btn{background:#4da3ff;color:#001a33;padding:.5rem .9rem;border-radius:.6rem;text-decoration:none;border:0;font-weight:600}
  .btn-outline{border:1px solid #4da3ff;color:#4da3ff;padding:.45rem .8rem;border-radius:.6rem;background:transparent;text-decoration:none}
  .inp{background:#0b1020;border:1px solid #243154;border-radius:.6rem;color:#e8eefc;padding:.55rem .6rem}
  .w-40{min-width:10rem;max-width:10rem}
  .w-64{min-width:16rem;max-width:16rem}
  .short-select{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
  .lbl{display:block;color:#9fb3d9;font-size:.9rem;margin:.3rem 0}
  .tbl{display:grid;gap:6px}
  .tr{display:grid;grid-template-columns:1fr 1.6fr .8fr .7fr 1.6fr;gap:8px;align-items:center;background:#0b1020;border:1px solid #243154;border-radius:10px;padding:8px}
  .tr.th{background:transparent;border:none;color:#9fb3d9;font-weight:600}
  .right{text-align:right;display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
  .inline{display:inline}
  .muted{color:#9fb3d9}
</style>
@endsection
