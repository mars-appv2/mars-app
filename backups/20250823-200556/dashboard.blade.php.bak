@extends('layouts.app')
@section('content')
<div class="container mx-auto px-2 md:px-4">
  <div class="mb-4 flex gap-2">
    <a href="{{ route('mikrotik.index') }}" class="btn btn-secondary">Table List</a>
    <a href="{{ route('mikrotik.dashboard',$mikrotik) }}" class="btn btn-primary">Dashboard</a>
    <a href="{{ route('mikrotik.pppoe',$mikrotik) }}" class="btn btn-secondary">PPPoE</a>
    <a href="{{ route('mikrotik.ipstatic',$mikrotik) }}" class="btn btn-secondary">IP Static</a>
  </div>

  <div class="card bg-slate-900/60 border border-slate-800">
    <div class="card-body">
      <div class="mb-3">
        <label class="block text-sm mb-1">Interface</label>
        <div class="flex items-center gap-2">
          <select id="iface" class="form-select max-w-md">
            @foreach($if as $row)
              @php $name=$row['name']??''; $type=$row['type']??''; @endphp
              <option value="{{ $name }}">{{ $name }} {{ $type ? '(' . $type . ')' : '' }}</option>
            @endforeach
          </select>
          <button id="btnSee" class="btn btn-primary">LIHAT</button>
          <span class="text-xs px-2 py-0.5 rounded bg-violet-500/20 text-violet-300 border border-violet-600/30">hotfix-v2</span>
        </div>
        <div id="mk-note" class="text-rose-300 text-sm mt-2"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <div class="text-slate-400 text-sm">RX</div>
          <div class="text-2xl font-bold" id="rxNum">0 bps</div>
          <progress id="rxBar" max="10000000000" value="0" class="w-full"></progress>
        </div>
        <div>
          <div class="text-slate-400 text-sm">TX</div>
          <div class="text-2xl font-bold" id="txNum">0 bps</div>
          <progress id="txBar" max="10000000000" value="0" class="w-full"></progress>
        </div>
      </div>

      <div class="mt-2 text-xs text-slate-400">Polling tiap 2 detik setelah klik LIHAT.</div>
    </div>
  </div>
</div>

<script>
(function(){
  if (window.__mkmon_patched) return;
  window.__mkmon_patched = true;

  const btn=document.getElementById("btnSee"); if(!btn) return;
  const p=btn.parentNode, cl=btn.cloneNode(true); p.replaceChild(cl,btn);

  const sel=document.getElementById("iface");
  const rxN=document.getElementById("rxNum"), txN=document.getElementById("txNum");
  const rxB=document.getElementById("rxBar"), txB=document.getElementById("txBar");
  const note=document.getElementById("mk-note");
  const tok="{{ csrf_token() }}";
  const url1="{{ route('mikrotik.monitor',['mikrotik'=>$mikrotik->id]) }}";
  const url2="{{ url('/mkmon/'.$mikrotik->id) }}";
  const url3="{{ url('/monx/'.$mikrotik->id) }}";

  function say(m){ if(note) note.textContent=m||""; }
  function fmt(n){ const u=["bps","Kbps","Mbps","Gbps"]; let i=0,x=Number(n||0); while(x>=1000&&i<u.length-1){x/=1000;i++;} return x.toFixed(2)+" "+u[i]; }
  function hit(u,iface){ return fetch(u,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":tok},body:JSON.stringify({iface})}); }

  let t=null;
  cl.addEventListener("click", ()=>{
    if(t){clearInterval(t);t=null;}
    const iface=sel&&sel.value; if(!iface){say("Pilih interface dulu");return;}
    say("");

    async function tick(){
      try{
        let r=await hit(url1,iface);
        if(!r.ok){ r=await hit(url2,iface); if(!r.ok){ r=await hit(url3,iface); if(!r.ok){ say("Gagal polling ("+r.status+")"); return; } } }
        const d=await r.json(); const rx=Number(d.rx||0), tx=Number(d.tx||0);
        rxN.textContent=fmt(rx); txN.textContent=fmt(tx); rxB.value=rx; txB.value=tx;
      }catch(e){ say("Gagal polling: "+(e&&e.message?e.message:e)); }
    }
    tick(); t=setInterval(tick,2000);
  });
})();
</script>
@endsection
